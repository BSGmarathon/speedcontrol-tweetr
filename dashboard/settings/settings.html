<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <script defer src="/components/button/button.js"></script>
    <script defer src="/components/input/input.js"></script>

    <style>
        nodecg-button {
            margin-bottom: 15px;
        }

        nodecg-input {
            margin-bottom: 15px;
        }

        input[type="file"] {
            display: none;
        }
    </style>
    <title>Tweetr settings</title>
</head>

<body>
    <nodecg-button id="autotweet" onClick="settings.value.autoTweet = !settings.value.autoTweet"></nodecg-button>
    <nodecg-input type="number" id="countdown" label="Countdown Time" onChange="settings.value.countdown = this.value"></nodecg-input>
    <nodecg-button id="import" onClick="document.getElementById('importInput').click()">Import Tweets</nodecg-button>
    <nodecg-button id="export" onClick="exportCSV();">Export Tweets</nodecg-button>
    <input type="file" accept=".csv" id="importInput" onChange="importCSV(this)"/>

    <script>
        const settings = nodecg.Replicant('settings');

        NodeCG.waitForReplicants(settings).then(() => {

            settings.on('change', (newVal) => {
                let autotweet = document.getElementById('autotweet');

                if (newVal.autoTweet) {
                    autotweet.buttonText = 'Disable Auto Tweet';
                    autotweet.backgroundColor = '#990000';
                } else {
                    autotweet.buttonText = 'Enable Auto Tweet';
                    autotweet.backgroundColor = '#272727';
                }

                document.getElementById('countdown').value = newVal.countdown;
            })
        })

        function importCSV(input) {
            let button = document.querySelector('#import');
            let file = input.files[0];

            if (!file.name.includes('.csv')) {
                return;
            }

            button.disabled = true;
            button.value = 'Uploading...'

            setTimeout(() => {
                const reader = new FileReader();
                reader.readAsText(file);
                reader.onload = () => {
                    nodecg.sendMessage('importCSV', reader.result)
                    button.disabled = false;
                    button.value = 'Import Tweets'
                };
            }, 1000)
        }

        function exportCSV() {
            let button = document.querySelector('#export');
            button.disabled = true;
            button.value = 'Generating CSV...'
            nodecg.sendMessage('exportCSV').then(result => {
                let element = document.createElement('a');
                element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(result));
                element.setAttribute('download', 'tweetr_data.csv');
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                button.value = 'Export Tweets'
                button.disabled = false;
            })
        }
    </script>
</body>

</html>
